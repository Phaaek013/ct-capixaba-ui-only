generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                       Int             @id @default(autoincrement())
  nome                     String
  email                    String          @unique
  avatarUrl                String?
  senhaHash                String
  tipo                     String          @default("Coach")
  senhaPrecisaTroca        Boolean         @default(true)
  ativo                    Boolean         @default(true)
  motivoBloqueio           String          @default("NENHUM") // NENHUM | FINANCEIRO | MANUAL
  diaVencimentoMensalidade Int?
  proximoVencimentoEm      DateTime?
  ultimoPagamentoEm        DateTime?
  createdAt                DateTime        @default(now())
  updatedAt                DateTime        @updatedAt
  treinos                  Treino[]        @relation("UsuarioTreinos")
  treinosCriados           Treino[]        @relation("CoachTreinos")
  feedbacks                Feedback[]
  documentos               DocumentoPDF[]
  logs                     LogAcao[]
  treinosConcluidos        TreinoConclusao[]
  mensagensChat            TreinoMensagem[]    @relation("UsuarioTreinoMensagem")
}

model Treino {
  id         Int        @id @default(autoincrement())
  aluno      Usuario?   @relation("UsuarioTreinos", fields: [alunoId], references: [id], onDelete: Cascade)
  alunoId    Int?
  coach      Usuario?   @relation("CoachTreinos", fields: [coachId], references: [id], onDelete: SetNull)
  coachId    Int?
  dataTreino DateTime?
  conteudo   String?
  videoUrl   String?
  ehModelo   Boolean    @default(false)
  nomeModelo String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  feedbacks  Feedback[]

  @@unique([alunoId, dataTreino])
  @@index([coachId])
  @@index([ehModelo])
}

model Feedback {
  id          Int      @id @default(autoincrement())
  aluno       Usuario  @relation(fields: [alunoId], references: [id], onDelete: Cascade)
  alunoId     Int
  treino      Treino   @relation(fields: [treinoId], references: [id], onDelete: Cascade)
  treinoId    Int
  nota        Int
  rpe         String?
  observacoes String?
  enviadoEm   DateTime @default(now())

  @@unique([alunoId, treinoId])
}

model DocumentoPDF {
  id        Int        @id @default(autoincrement())
  titulo    String
  filePath  String
  dataEnvio DateTime   @default(now())
  alunos    Usuario[]
}

model PdfDocumento {
  id           Int          @id @default(autoincrement())
  titulo       String
  descricao    String?
  categoria    String       @default("OUTRO")
  arquivoPath  String
  criadoEm     DateTime     @default(now())
  atualizadoEm DateTime     @updatedAt
}

model Config {
  id           Int      @id @default(1)
  limiteAlunos Int      @default(100)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model LogAcao {
  id        Int       @id @default(autoincrement())
  usuario   Usuario?  @relation(fields: [usuarioId], references: [id], onDelete: SetNull)
  usuarioId Int?
  tipoAcao  String
  detalhes  String?
  dataHora  DateTime  @default(now())
}

model Pdf {
  id          Int      @id @default(autoincrement())
  titulo      String
  slug        String   @unique
  descricao   String?
  arquivoPath String
  criadoEm    DateTime @default(now())
  ativo       Boolean  @default(true)
}

model TreinoConclusao {
  id            Int             @id @default(autoincrement())
  usuarioId     Int
  treinoId      String
  dataConclusao DateTime        @default(now())
  feedbackText  String?

  usuario   Usuario          @relation(fields: [usuarioId], references: [id])
  mensagens TreinoMensagem[]

  @@index([usuarioId])
  @@index([treinoId])
  @@unique([usuarioId, treinoId])
}

model TreinoMensagem {
  id                Int             @id @default(autoincrement())
  treinoConclusaoId Int
  autorId           Int
  texto             String
  criadoEm          DateTime        @default(now())
  lidoPeloAlunoEm   DateTime?
  lidoPeloCoachEm   DateTime?

  treinoConclusao TreinoConclusao @relation(fields: [treinoConclusaoId], references: [id], onDelete: Cascade)
  autor           Usuario         @relation("UsuarioTreinoMensagem", fields: [autorId], references: [id])

  @@index([treinoConclusaoId, criadoEm])
  @@index([treinoConclusaoId, lidoPeloAlunoEm])
  @@index([treinoConclusaoId, lidoPeloCoachEm])
}
